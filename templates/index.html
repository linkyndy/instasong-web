<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Flat UI Kit - HTML/PSD Design Framework</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    {% assets "css" %}
			<link href="{{ ASSET_URL }}" rel="stylesheet">
		{% endassets %}

    <link rel="shortcut icon" href="images/favicon.ico">

		{% assets "js_upper" %}
			<script src="{{ ASSET_URL }}"></script>
		{% endassets %}

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements. All other JS at the end of file. -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.js"></script>
    <![endif]-->
  </head>
  <body>
		<div id="fb-root"></div>
		<script>
			$(document).ready(function() {
				// Load Facebook SDK
				$.ajax({
					url: '//connect.facebook.net/en_US/all.js',
					dataType: 'script',
					cache: true,
					success: function() {
						// Init Facebook SDK
						FB.init({
					   	appId: "{{ config['FACEBOOK_APP_ID'] }}",
				      channelUrl: "{{ url_for('static', filename='channel.html') }}",
				      status: true, // Also check login status (used below)
				      cookie: true, // Allow backend to get user session
				      xfbml: true
				    });
						
						// Subscribe to auth changes
						FB.Event.subscribe('auth.statusChange', function(response) {
							if (response.status === 'connected') {
								$("#facebook").html(logoutLink() + suggestionLink("{{ url_for('suggest') }}"))
					    } else if (response.status === 'not_authorized') {
					      $("#facebook").html(loginLink())
					    } else {
					      $("#facebook").html(loginLink())
					    }
						});
						
						/* Workaround to display login link when not connected
						 * This should be triggered in the event subscription
						 * above, but for some reason, it isn't.
						 */
						FB.getLoginStatus(function(response) {
							if (response.status !== 'connected') {
					      $("#facebook").html(loginLink())
					    }
						});
					}
				});
			});
			
			function login() {
				FB.login(function(response) {
					if (response.authResponse) {
						$("#facebook").html(logoutLink() + suggestionLink("{{ url_for('suggest') }}"))
					} else {
					}
				}, {scope: 'user_likes'});
			}
			
			function logout() {
				FB.logout(function(response) {
					$("#facebook").html(loginLink())
				});
			}
			
			function getSuggestion() {
				$("#suggestion").html("Getting suggestion...")
				$.getJSON('{{ url_for("suggest") }}', function(data) {
						if (data.type === 'success') {
							$("#suggestion").html(data.data.artist + "<br>" + data.data.song + "<br>" + data.data.url);
						} else {
							$("#suggestion").html(data.message);
						}
				});
			}
			
			function loginLink() {
				return '<a href="#" onclick="login();" class="btn btn-primary btn-large">Connect with Facebook</a>'
			}
			
			function logoutLink() {
				return '<a href="#" onclick="logout();" class="btn btn-primary btn-large">Log out</a>'
			}
			
			function suggestionLink() {
				return '<a href="#" onclick="getSuggestion();" class="btn btn-primary btn-large">Get suggestion</a>'
			}
		</script>
		
    <div class="container">
			<div id="facebook" class="row">
				<span>Checking user...</span>
      </div>
			<div id="suggestion" class="row">
				
			</div>
    </div> <!-- /container -->

    <!-- Load JS here for greater good =============================-->
    {% assets "js_lower" %}
			<script src="{{ ASSET_URL }}"></script>
		{% endassets %}
  </body>
</html>
