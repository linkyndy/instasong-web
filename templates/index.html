<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Flat UI Kit - HTML/PSD Design Framework</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    {% assets "css" %}
			<link href="{{ ASSET_URL }}" rel="stylesheet">
		{% endassets %}

    <link rel="shortcut icon" href="images/favicon.ico">

		{% assets "js_upper" %}
			<script src="{{ ASSET_URL }}"></script>
		{% endassets %}

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements. All other JS at the end of file. -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.js"></script>
    <![endif]-->
  </head>
  <body>
		<div id="fb-root"></div>
		<script>
			$(document).ready(function() {
				// Load Facebook SDK
				$.ajax({
					url: '//connect.facebook.net/en_US/all.js',
					dataType: 'script',
					cache: true,
					success: function() {
						// Init Facebook SDK
						FB.init({
					   	appId: "{{ config['FACEBOOK_APP_ID'] }}",
				      channelUrl: "{{ url_for('static', filename='channel.html') }}",
				      status: true, // Also check login status (used below)
				      cookie: true, // Allow backend to get user session
				      xfbml: true
				    });
						
						// Subscribe to auth changes
						FB.Event.subscribe('auth.statusChange', function(response) {
							if (response.status === 'connected') {
								FB.api('/me', function(response) {
									whenLoggedWithoutSuggestion(response.first_name);
								});
					    } else if (response.status === 'not_authorized') {
					      whenNotLogged();
					    } else {
					      whenNotLogged();
					    }
						});
						
						/* Workaround to display login link when not connected
						 * This should be triggered in the event subscription
						 * above, but for some reason, it isn't.
						 */
						FB.getLoginStatus(function(response) {
							if (response.status !== 'connected') {
					      whenNotLogged();
					    }
						});
					}
				});
			});
			
			function login() {
				FB.login(function(response) {
					if (response.authResponse) {
						FB.api('/me', function(response) {
							whenLoggedWithoutSuggestion(response.first_name);
						});
					} else {
					}
				}, {scope: 'user_likes'});
			}
			
			function logout() {
				FB.logout(function(response) {
					whenNotLogged();
				});
			}
			
			function getSuggestion() {
				$("#suggestion").html("Getting suggestion...")
				$.getJSON('{{ url_for("suggest") }}', function(data) {
						whenLoggedWithSuggestion(data);
				});
			}
			
			function loginLink() {
				return '<a href="#" onclick="login();">connecting your Facebook account</a>'
			}
			
			function logoutLink() {
				return '<a href="#" onclick="logout();">disconnect your account</a>'
			}
			
			function suggestionLink(x) {
				if (x == 0) {
					return '<a href="#" onclick="getSuggestion();">this song</a>'
				} else if (x == 1) {
					return '<a href="#" onclick="getSuggestion();">try another one</a>'
				} else if (x == 2) {
					return '<a href="#" onclick="getSuggestion();">Try again</a>'
				}
			}
			
			function whenNotLogged() {
				$("#container").html('<div class="row"><h3>Fancy listening to a great song? Get started by ' + loginLink() + '</h3></div>')
			}
			
			function whenLoggedWithoutSuggestion(username) {
				$("#container").html('<div class="row"><h3>Hi there, ' + username + '! Brighten your day with ' + suggestionLink(0) + '!</h3><h6>Or maybe ' + logoutLink() + '?</h6></div>')
			}
			
			function whenLoggedWithSuggestion(suggestion) {
				if (suggestion.type === 'success') {
					$("#container").html('<div class="row"><h3>Here\'s what we\'ve got for you...</h3><h2>' + suggestion.data.artist + ' - ' + suggestion.data.song + '</h2><h6>Liked it? Here, ' + suggestionLink(1) + '! Or maybe ' + logoutLink() + '?</h6></div>')
				} else {
					$("#container").html('<div class="row"><h3>Oh blast! There was an error with your suggestion. ' + suggestionLink(2) + '!</h3><h6>Or maybe ' + logoutLink() + '?</h6></div>')
				}
			}
		</script>
		
    <div id="container" class="container">
			<h3>Loading...</h3>
    </div> <!-- /container -->

    <!-- Load JS here for greater good =============================-->
    {% assets "js_lower" %}
			<script src="{{ ASSET_URL }}"></script>
		{% endassets %}
  </body>
</html>
